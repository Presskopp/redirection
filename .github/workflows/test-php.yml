name: PHPUnit

on:
  pull_request:
    paths:
      - '**/*.php'
      - '**/composer.lock'
      - '**/phpcs.xml'
      - '**/phpunit.xml.dist'
      - '**/psalm.xml'

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
          php-version: '7.4'

    - uses: actions/checkout@v2

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v2
      with:
          path: vendor
          key: ${{ runner.os }}-node-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
              ${{ runner.os }}-node-

    - name: Install dependencies
      if: steps.composer-cache.outputs.cache-hit != 'true'
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Run unit tests
      run: composer test

    - name: Start MySQL
      run: sudo /etc/init.d/mysql start

    - name: Install dependencies
      run: composer update --prefer-dist --no-interaction --no-suggest

    - name: Setup tests
      run: bash bin/install-wp-tests.sh wordpress_test root root localhost latest

    - name: Working Directory
      run: pwd

    - name: Execute tests
      run: yarn test:php
      env:
          DB_PORT: ${{ job.services.mysql.ports[3306] }}
